# =============================================================================
# ADI Local Development - Hive Configuration
# =============================================================================
# Usage: adi hive up
#
# This replaces .adi/workflows/dev.sh with a declarative configuration.
# All services that were in dev.sh are now managed by Hive.
#
# Default services to start: postgres, timescaledb, coturn, signaling, logging,
#                           auth, platform, web, web-app, flowmap,
#                           analytics-ingestion, analytics, llm-proxy
#
# Optional services: balance, credentials, cocoon, registry, codegen
# =============================================================================

version: "1"

# -----------------------------------------------------------------------------
# Global Defaults
# -----------------------------------------------------------------------------

defaults:
  # File-based logging with rotation (defaults to ~/.adi/hive/logs/)
  hive.obs.file:
    rotate: true
    max_size: 10MB

  # Console output for development
  hive.obs.stdout:
    format: pretty
    level: info

  # Default health check settings
  hive.health.http:
    timeout: 5s
    interval: 10s
    retries: 3

  hive.health.tcp:
    timeout: 5s
    interval: 5s
    retries: 3

# -----------------------------------------------------------------------------
# Reverse Proxy Configuration
# -----------------------------------------------------------------------------
# Hosts:
#   - adi.local              (local development)
#   - adi-local.the-ihor.com (via Cloudflare tunnel, rewrites Host to adi.local)

proxy:
  bind:
    - "127.0.0.1:8080"

# -----------------------------------------------------------------------------
# Global Observability
# -----------------------------------------------------------------------------

observability:
  plugins:
    - stdout
    - file

# -----------------------------------------------------------------------------
# Global Environment (inherited by all services)
# -----------------------------------------------------------------------------

environment:
  dotenv:
    files:
      - .env.local
  static:
    RUST_LOG: info
    SHOW_VERSION_IN_HEADERS: "true"

# =============================================================================
# Services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Infrastructure: Databases
  # ---------------------------------------------------------------------------

  postgres:
    runner:
      type: docker
      docker:
        image: postgres:16-alpine
        container_name: adi-postgres
        ports:
          - "8027:5432"
        volumes:
          - adi-postgres-data:/var/lib/postgresql/data
          - ./scripts/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql:ro
        environment:
          POSTGRES_USER: adi
          POSTGRES_PASSWORD: adi
          POSTGRES_DB: adi
    rollout:
      type: recreate
      recreate:
        ports:
          db: 8027
    healthcheck:
      type: cmd
      cmd:
        command: pg_isready -U adi
        interval: 5s
        timeout: 5s
        retries: 5
    restart: unless-stopped

  timescaledb:
    runner:
      type: docker
      docker:
        image: timescale/timescaledb:latest-pg16
        container_name: adi-timescaledb
        ports:
          - "8028:5432"
        volumes:
          - adi-timescaledb-data:/var/lib/postgresql/data
          - ./scripts/init-timescaledb.sql:/docker-entrypoint-initdb.d/init-timescaledb.sql:ro
        environment:
          POSTGRES_USER: adi
          POSTGRES_PASSWORD: adi
          POSTGRES_DB: adi_analytics
    rollout:
      type: recreate
      recreate:
        ports:
          db: 8028
    healthcheck:
      type: cmd
      cmd:
        command: pg_isready -U adi
        interval: 5s
        timeout: 5s
        retries: 5
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Infrastructure: TURN Server for WebRTC
  # ---------------------------------------------------------------------------

  coturn:
    runner:
      type: docker
      docker:
        image: coturn/coturn:latest
        container_name: adi-coturn
        network_mode: host
        command:
          - "turnserver"
          - "-n"
          - "--log-file=stdout"
          - "--listening-port=8039"
          - "--fingerprint"
          - "--lt-cred-mech"
          - "--user=adi:adi"
          - "--realm=adi.local"
          - "--no-tls"
          - "--no-dtls"
          - "--no-cli"
    rollout:
      type: recreate
      recreate:
        ports:
          turn: 8039
    healthcheck:
      type: cmd
      cmd:
        command: "nc -z localhost 8039 || exit 0"
        interval: 10s
        timeout: 5s
        retries: 3
        start_period: 5s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Core Services
  # ---------------------------------------------------------------------------

  signaling:
    runner:
      type: script
      script:
        run: cargo run --bin signaling-server
        working_dir: crates/signaling-server
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8011
    proxy:
      - host: adi.local
        path: /api/signaling
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/signaling
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8011"
        HIVE_SECRETS: ${env.HIVE_SECRETS:-}
        LOGGING_URL: "http://localhost:8040"
    restart: on-failure
    # Expose signaling URL for other services
    expose:
      name: signaling
      vars:
        URL: "ws://localhost:8011/ws"
        PORT: "8011"

  logging:
    runner:
      type: script
      script:
        run: cargo run --bin logging-http
        working_dir: crates/logging
    hooks:
      pre-up:
        - run: cargo run --bin logging-migrate --features migrate all
          working_dir: crates/lib/lib-logging-core
          timeout: "120s"
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8040
    proxy:
      - host: adi.local
        path: /api/logging
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/logging
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8040"
        DATABASE_URL: "postgres://adi:adi@localhost:8028/adi_logging"
    depends_on:
      - timescaledb
    restart: on-failure
    # Expose logging URL for other services
    expose:
      name: logging
      vars:
        URL: "http://localhost:8040"

  auth:
    runner:
      type: script
      script:
        run: cargo run -p auth-http
        working_dir: crates/auth
    hooks:
      pre-up:
        - run: cargo run --bin auth-migrate -- run
          working_dir: crates/auth/cli
          timeout: "120s"
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8012
    proxy:
      - host: adi.local
        path: /api/auth
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/auth
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8012"
        DATABASE_URL: "postgres://adi:adi@localhost:8027/adi_auth"
        JWT_SECRET: ${env.JWT_SECRET:-dev-jwt-secret-change-in-production-min-32-chars}
        ADMIN_EMAILS: ${env.ADMIN_EMAILS:-}
        SMTP_HOST: ${env.SMTP_HOST:-}
        SMTP_PORT: ${env.SMTP_PORT:-}
        SMTP_USERNAME: ${env.SMTP_USERNAME:-}
        SMTP_PASSWORD: ${env.SMTP_PASSWORD:-}
        SMTP_FROM_EMAIL: ${env.SMTP_FROM_EMAIL:-}
        SMTP_FROM_NAME: ${env.SMTP_FROM_NAME:-}
        SMTP_TLS: ${env.SMTP_TLS:-}
        UNSAFE_PRINT_EMAIL_CODE_IN_CONSOLE: ${env.UNSAFE_PRINT_EMAIL_CODE_IN_CONSOLE:-true}
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - postgres
      - logging
    restart: on-failure

  platform:
    runner:
      type: script
      script:
        run: cargo run --bin platform-http
        working_dir: crates/platform
    hooks:
      pre-up:
        - run: cargo run -p platform-cli --bin platform -- migrate all
          working_dir: crates/platform
          timeout: "120s"
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8015
    proxy:
      - host: adi.local
        path: /api/platform
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/platform
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8015"
        DATABASE_URL: "postgres://adi:adi@localhost:8027/adi_platform"
        JWT_SECRET: ${env.JWT_SECRET:-dev-jwt-secret-change-in-production-min-32-chars}
        PUBLIC_BASE_URL: ${env.PUBLIC_BASE_URL:-http://adi.local}
        CORS_ORIGIN: "http://adi.local"
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - postgres
      - logging
    restart: on-failure

  # ---------------------------------------------------------------------------
  # Web Frontends
  # ---------------------------------------------------------------------------

  web:
    runner:
      type: script
      script:
        run: npm run dev
        working_dir: apps/infra-service-web
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8013
    proxy:
      - host: adi.local
        path: /
      - host: adi-local.the-ihor.com
        path: /
    healthcheck:
      type: tcp
      tcp:
        port: "{{runtime.port.http}}"
    environment:
      static:
        PORT: "8013"
        AUTH_API_URL: "http://adi.local/api/auth"
        NEXT_PUBLIC_PLATFORM_API_URL: "http://adi.local/api/platform"
        NEXT_PUBLIC_FLOWMAP_API_URL: "http://adi.local/api/flowmap"
        NEXT_PUBLIC_CREDENTIALS_API_URL: "http://adi.local/api/credentials"
        NEXT_PUBLIC_SIGNALING_URL: "ws://adi.local/api/signaling/ws"
    depends_on:
      - auth
      - platform
    restart: on-failure

  web-app:
    runner:
      type: script
      script:
        run: npm run dev
        working_dir: apps/web-app
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8035
    proxy:
      - host: adi.local
        path: /app
      - host: adi-local.the-ihor.com
        path: /app
    healthcheck:
      type: tcp
      tcp:
        port: "{{runtime.port.http}}"
    environment:
      static:
        PORT: "8035"
        VITE_SIGNALING_URL: "/api/signaling/ws"
    restart: on-failure

  # ---------------------------------------------------------------------------
  # API Services
  # ---------------------------------------------------------------------------

  flowmap:
    runner:
      type: script
      script:
        run: cargo run --release --bin flowmap-api
        working_dir: apps/flowmap-api
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8017
    proxy:
      - host: adi.local
        path: /api/flowmap
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/flowmap
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8017"
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - logging
    restart: on-failure

  analytics-ingestion:
    runner:
      type: script
      script:
        run: cargo run --bin analytics-ingestion
        working_dir: crates/analytics-ingestion
    hooks:
      pre-up:
        - run: cargo run --bin analytics-migrate --features migrate all
          working_dir: crates/lib/lib-analytics-core
          timeout: "120s"
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8022
    proxy:
      - host: adi.local
        path: /api/analytics-ingestion
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/analytics-ingestion
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8022"
        DATABASE_URL: "postgres://adi:adi@localhost:8028/adi_analytics"
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - timescaledb
      - logging
    restart: on-failure
    # Expose analytics URL for other services
    expose:
      name: analytics-ingestion
      vars:
        URL: "http://localhost:8022"

  analytics:
    runner:
      type: script
      script:
        run: cargo run --bin analytics-http
        working_dir: crates/analytics
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8023
    proxy:
      - host: adi.local
        path: /api/analytics
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/analytics
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8023"
        DATABASE_URL: "postgres://adi:adi@localhost:8028/adi_analytics"
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - timescaledb
      - logging
    restart: on-failure

  llm-proxy:
    runner:
      type: script
      script:
        run: cargo run --bin llm-proxy
        working_dir: crates/llm-proxy/http
    hooks:
      pre-up:
        - run: cargo run --bin llm-proxy-migrate
          working_dir: crates/llm-proxy/http
          timeout: "120s"
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8029
    proxy:
      - host: adi.local
        path: /api/llm-proxy
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/llm-proxy
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8029"
        DATABASE_URL: "postgres://adi:adi@localhost:8027/adi_llm_proxy"
        JWT_SECRET: ${env.JWT_SECRET:-dev-jwt-secret-change-in-production-min-32-chars}
        ADMIN_JWT_SECRET: ${env.ADMIN_JWT_SECRET:-}
        ENCRYPTION_KEY: ${env.ENCRYPTION_KEY:-5a747f27420b903522ae3746c4ba79b5ecffea02f6bc333fd4da39fb2ef27de4}
        ANALYTICS_URL: "http://localhost:8022"
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - postgres
      - analytics-ingestion
      - logging
    restart: on-failure

  shortcuts:
    runner:
      type: script
      script:
        run: cargo run --bin shortcuts-http
        working_dir: crates/shortcuts
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8031
    proxy:
      - host: adi.local
        path: /sc
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /sc
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8031"
        CONFIG_PATH: ".adi/shortcuts.yaml"
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - logging
    restart: on-failure

  # ---------------------------------------------------------------------------
  # Optional Services
  # ---------------------------------------------------------------------------

  balance:
    runner:
      type: script
      script:
        run: cargo run --bin balance-http
        working_dir: crates/balance
    hooks:
      pre-up:
        - run: cargo run --bin balance-migrate all
          working_dir: crates/balance
          timeout: "120s"
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8030
    proxy:
      - host: adi.local
        path: /api/balance
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/balance
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8030"
        DATABASE_URL: "postgres://adi:adi@localhost:8027/adi_balance"
        JWT_SECRET: ${env.JWT_SECRET:-dev-jwt-secret-change-in-production-min-32-chars}
        ANALYTICS_URL: "http://localhost:8022"
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - postgres
      - analytics-ingestion
      - logging
    restart: on-failure

  credentials:
    runner:
      type: script
      script:
        run: cargo run --bin credentials-http
        working_dir: crates/credentials
    hooks:
      pre-up:
        - run: cargo run --bin credentials-migrate all
          working_dir: crates/credentials
          timeout: "120s"
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8033
    proxy:
      - host: adi.local
        path: /api/credentials
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/credentials
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8033"
        DATABASE_URL: "postgres://adi:adi@localhost:8027/adi_credentials"
        JWT_SECRET: ${env.JWT_SECRET:-dev-jwt-secret-change-in-production-min-32-chars}
        ENCRYPTION_KEY: ${env.ENCRYPTION_KEY:-5a747f27420b903522ae3746c4ba79b5ecffea02f6bc333fd4da39fb2ef27de4}
        ANALYTICS_URL: "http://localhost:8022"
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - postgres
      - analytics-ingestion
      - logging
    restart: on-failure

  registry:
    runner:
      type: script
      script:
        run: cargo run --bin plugin-registry
        working_dir: crates/plugin-registry
    rollout:
      type: recreate
      recreate:
        ports:
          http: 8019
    proxy:
      - host: adi.local
        path: /api/registry
        strip_prefix: true
      - host: adi.local
        path: /registry
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /api/registry
        strip_prefix: true
      - host: adi-local.the-ihor.com
        path: /registry
        strip_prefix: true
    healthcheck:
      type: http
      http:
        port: "{{runtime.port.http}}"
        path: /health
    environment:
      static:
        PORT: "8019"
        REGISTRY_DATA_DIR: ${env.REGISTRY_DATA_DIR:-.adi/dev/registry-data}
        LOGGING_URL: "http://localhost:8040"
    depends_on:
      - logging
    restart: on-failure

  # ---------------------------------------------------------------------------
  # Cloudflare Tunnel (exposes local dev to adi-local.the-ihor.com)
  # ---------------------------------------------------------------------------
  # Setup:
  #   1. Install cloudflared: brew install cloudflared
  #   2. Login: cloudflared tunnel login
  #   3. Create tunnel: cloudflared tunnel create adi-local
  #   4. Add DNS: cloudflared tunnel route dns adi-local adi-local.the-ihor.com
  #   5. Copy tunnel credentials to ~/.cloudflared/<tunnel-id>.json
  #   6. Set CF_TUNNEL_ID in .env.local
  #
  # Basic auth is configured in the tunnel config file (~/.cloudflared/config.yml)
  # ---------------------------------------------------------------------------

  cloudflare-tunnel:
    runner:
      type: script
      script:
        run: |
          cloudflared tunnel --config ~/.cloudflared/adi-local.yml run adi-local
    rollout:
      type: recreate
      recreate:
        ports: {}
    healthcheck:
      type: cmd
      cmd:
        command: pgrep -f "cloudflared tunnel.*adi-local" || exit 1
        interval: 10s
        timeout: 5s
        retries: 3
    environment:
      static:
        TUNNEL_ORIGIN_CERT: ${env.CF_ORIGIN_CERT:-~/.cloudflared/cert.pem}
    depends_on:
      - web
      - auth
      - platform
    restart: on-failure
