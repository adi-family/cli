<!-- 
  Auto-generated documentation for lib-embed
  Language: Ukrainian
  Generated: 2026-01-31T23:54:09Z
  
  This file was generated by: adi workflow autodoc
  To regenerate: adi workflow autodoc --force
-->

# lib-embed

## Огляд

`lib-embed` — це спільна бібліотека для генерації текстових вкладень (embeddings) в ADI інструментах. Бібліотека надає уніфікований інтерфейс для різних провайдерів вкладень, включаючи плагін-базований підхід та локальну FastEmbed реалізацію.

Основні можливості:
- Уніфікований трейт `Embedder` для різних провайдерів
- Плагін-базована архітектура (за замовчуванням) через `adi.embed` плагін
- Опціональна локальна FastEmbed підтримка з ONNX моделями
- Гнучке налаштування через TOML конфігурацію
- Оптимізовано для коду та технічного контенту

## Встановлення

Додайте до вашого `Cargo.toml`:

```toml
[dependencies]
lib-embed = "0.8.4"
```

Для локальних ONNX моделей увімкніть feature `fastembed`:

```toml
[dependencies]
lib-embed = { version = "0.8.4", features = ["fastembed"] }
```

**Примітка**: Feature `fastembed` додає ~20MB до розміру бінарного файлу.

## Швидкий старт

### Плагін-базований підхід (рекомендовано)

```rust
use lib_embed::{Embedder, PluginEmbedder};
use lib_plugin_host::PluginManagerV3;
use std::sync::Arc;

// Створюємо менеджер плагінів
let plugin_manager = Arc::new(PluginManagerV3::new());

// Перевіряємо наявність плагіна
if !PluginEmbedder::is_available(&plugin_manager) {
    eprintln!("Встановіть плагін: adi plugin install adi.embed");
    return;
}

// Створюємо embedder
let embedder = PluginEmbedder::new(plugin_manager)?;

// Генеруємо вкладення
let texts = ["function calculateSum(a, b) { return a + b; }"];
let embeddings = embedder.embed(&texts)?;

println!("Розмірність: {}", embedder.dimensions());
println!("Модель: {}", embedder.model_name());
```

### Локальний FastEmbed (опціонально)

```rust
#[cfg(feature = "fastembed")]
use lib_embed::{FastEmbedder, Embedder};

#[cfg(feature = "fastembed")]
{
    let embedder = FastEmbedder::new()?;
    let texts = ["const greeting = 'Hello, world!';"];
    let embeddings = embedder.embed(&texts)?;
}
```

## API Reference

### `EmbeddingConfig`

Структура для налаштування провайдерів вкладень.

```rust
pub struct EmbeddingConfig {
    pub provider: String,      // Назва провайдера (наприклад, "fastembed")
    pub model: String,         // Ідентифікатор моделі
    pub dimensions: u32,       // Розмірність вкладень
    pub batch_size: usize,     // Розмір батча для обробки
    pub api_key: Option<String>,    // API ключ для віддалених провайдерів
    pub api_base: Option<String>,   // Базовий URL для віддалених провайдерів
}
```

#### Методи

- `load_user_config() -> Result<Self>` - завантажує конфігурацію з файлу користувача
- `load_from_file(path: &Path) -> Result<Self>` - завантажує конфігурацію з TOML файлу
- `merge(self, other: Self) -> Self` - об'єднує дві конфігурації

**Приклад використання:**

```rust
use lib_embed::EmbeddingConfig;

// Завантаження користувацької конфігурації
let config = EmbeddingConfig::load_user_config()?;

// Створення власної конфігурації
let custom_config = EmbeddingConfig {
    provider: "fastembed".to_string(),
    model: "jinaai/jina-embeddings-v2-base-code".to_string(),
    dimensions: 768,
    batch_size: 16,
    ..Default::default()
};
```

### `Embedder` (трейт)

Основний трейт для провайдерів текстових вкладень.

```rust
pub trait Embedder: Send + Sync {
    fn embed(&self, texts: &[&str]) -> Result<Vec<Vec<f32>>>;
    fn dimensions(&self) -> u32;
    fn model_name(&self) -> &str;
}
```

#### Методи

- `embed(texts: &[&str]) -> Result<Vec<Vec<f32>>>` - генерує вкладення для масиву текстів
- `dimensions() -> u32` - повертає розмірність вкладень
- `model_name() -> &str` - повертає назву моделі

### `PluginEmbedder`

Плагін-базована реалізація embedder'а через `adi.embed` сервіс.

```rust
pub struct PluginEmbedder { /* приватні поля */ }
```

#### Методи

- `new(plugin_manager: Arc<PluginManagerV3>) -> Result<Self>` - створює новий плагін embedder
- `is_available(plugin_manager: &PluginManagerV3) -> bool` - перевіряє наявність плагіна

**Приклад:**

```rust
use lib_embed::PluginEmbedder;
use lib_plugin_host::PluginManagerV3;

let manager = Arc::new(PluginManagerV3::new());
if PluginEmbedder::is_available(&manager) {
    let embedder = PluginEmbedder::new(manager)?;
    let result = embedder.embed(&["код для аналізу"])?;
}
```

### `FastEmbedder` (опціонально)

Локальна FastEmbed реалізація з ONNX моделями.

```rust
#[cfg(feature = "fastembed")]
pub struct FastEmbedder { /* приватні поля */ }
```

#### Методи

- `new() -> Result<Self>` - створює з налаштуваннями за замовчуванням
- `with_config(config: &EmbeddingConfig) -> Result<Self>` - створює з власними налаштуваннями
- `from_user_config() -> Result<Self>` - створює з користувацькою конфігурацією

### `EmbedError`

Перечислення помилок бібліотеки.

```rust
pub enum EmbedError {
    Embedding(String),      // Помилки процесу генерації вкладень
    Config(String),         // Помилки конфігурації
    Io(std::io::Error),     // I/O помилки
    TomlParse(toml::de::Error),      // Помилки парсингу TOML
    TomlSerialize(toml::ser::Error), // Помилки серіалізації TOML
}
```

## Поширені шаблони використання

### 1. Автоматичний вибір провайдера

```rust
use lib_embed::{Embedder, PluginEmbedder};
use lib_plugin_host::PluginManagerV3;
use std::sync::Arc;

fn create_embedder() -> lib_embed::Result<Box<dyn Embedder>> {
    let plugin_manager = Arc::new(PluginManagerV3::new());
    
    // Спробуємо плагін спочатку
    if PluginEmbedder::is_available(&plugin_manager) {
        let embedder = PluginEmbedder::new(plugin_manager)?;
        return Ok(Box::new(embedder));
    }
    
    // Fallback до локального FastEmbed
    #[cfg(feature = "fastembed")]
    {
        use lib_embed::FastEmbedder;
        let embedder = FastEmbedder::new()?;
        return Ok(Box::new(embedder));
    }
    
    Err(lib_embed::EmbedError::Config(
        "Немає доступних провайдерів вкладень".to_string()
    ))
}
```

### 2. Батчева обробка текстів

```rust
use lib_embed::{Embedder, EmbeddingConfig};

async fn process_large_dataset(
    embedder: &dyn Embedder,
    texts: Vec<String>,
    batch_size: usize
) -> lib_embed::Result<Vec<Vec<f32>>> {
    let mut all_embeddings = Vec::new();
    
    for chunk in texts.chunks(batch_size) {
        let text_refs: Vec<&str> = chunk.iter().map(|s| s.as_str()).collect();
        let mut embeddings = embedder.embed(&text_refs)?;
        all_embeddings.append(&mut embeddings);
        
        // Додаємо невелику затримку для уникнення навантаження
        tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;
    }
    
    Ok(all_embeddings)
}
```

### 3. Конфігурація з файлу

Створіть файл `~/.config/adi/config.toml`:

```toml
[embedding]
provider = "fastembed"
model = "jinaai/jina-embeddings-v2-base-code"
dimensions = 768
batch_size = 32
```

Використання:

```rust
use lib_embed::{EmbeddingConfig, FastEmbedder};

#[cfg(feature = "fastembed")]
{
    let config = EmbeddingConfig::load_user_config()?;
    let embedder = FastEmbedder::with_config(&config)?;
    
    println!("Використовується модель: {}", embedder.model_name());
    println!("Розмірність: {}", embedder.dimensions());
}
```

## Обробка помилок

Бібліотека використовує власний тип `Result<T>` для обробки помилок:

```rust
use lib_embed::{EmbedError, Result, PluginEmbedder};

fn handle_embedding_errors() {
    match create_embedder_and_process() {
        Ok(embeddings) => println!("Успішно згенеровано {} вкладень", embeddings.len()),
        Err(EmbedError::Embedding(msg)) => {
            eprintln!("Помилка генерації вкладень: {}", msg);
        },
        Err(EmbedError::Config(msg)) => {
            eprintln!("Помилка конфігурації: {}", msg);
        },
        Err(EmbedError::Io(err)) => {
            eprintln!("I/O помилка: {}", err);
        },
        Err(err) => {
            eprintln!("Невідома помилка: {}", err);
        }
    }
}

fn create_embedder_and_process() -> Result<Vec<Vec<f32>>> {
    // Ваш код тут
    todo!()
}
```

## Дивіться також

- [lib-plugin-host](../lib-plugin-host/README.md) - Система управління плагінами
- [lib-plugin-abi-v3](../lib-plugin-abi-v3/README.md) - API для плагінів версії 3
- [FastEmbed](https://github.com/Anush008/fastembed-rs) - Rust бібліотека для локальних вкладень
- [adi plugin install adi.embed](../../README.md#plugins) - Установка плагіна вкладень
