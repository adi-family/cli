<!-- 
  Auto-generated documentation for lib-embed
  Language: English
  Generated: 2026-01-31T23:53:15Z
  
  This file was generated by: adi workflow autodoc
  To regenerate: adi workflow autodoc --force
-->

# lib-embed

## Overview

`lib-embed` is a shared text embedding library for the ADI tools ecosystem. It provides a unified interface for generating text embeddings through multiple backends, including plugin-based services and optional local ONNX models.

The library is designed with flexibility in mind, offering both lightweight plugin-based embeddings (default) and feature-gated local embeddings for environments where external dependencies are preferred.

## Installation

Add this to your `Cargo.toml`:

```toml
[dependencies]
lib-embed = "0.8.4"
```

For local FastEmbed support (adds ~20MB to binary):

```toml
[dependencies]
lib-embed = { version = "0.8.4", features = ["fastembed"] }
```

## Quick Start

```rust
use lib_embed::{Embedder, PluginEmbedder};
use lib_plugin_host::PluginManagerV3;
use std::sync::Arc;

// Using plugin-based embedder (recommended)
let plugin_manager = Arc::new(PluginManagerV3::new());
let embedder = PluginEmbedder::new(plugin_manager)?;

// Generate embeddings for text
let texts = ["Hello world", "Embedding example"];
let embeddings = embedder.embed(&texts)?;

println!("Generated {} embeddings with {} dimensions", 
         embeddings.len(), embedder.dimensions());
```

## API Reference

### Core Trait

#### `Embedder`

The main trait for text embedding providers.

```rust
pub trait Embedder: Send + Sync {
    fn embed(&self, texts: &[&str]) -> Result<Vec<Vec<f32>>>;
    fn dimensions(&self) -> u32;
    fn model_name(&self) -> &str;
}
```

- **`embed`** - Generates embeddings for a batch of texts
  - `texts`: Slice of text strings to embed
  - Returns: Vector of embedding vectors (one per input text)
- **`dimensions`** - Returns the dimensionality of the embedding vectors
- **`model_name`** - Returns the name/identifier of the underlying model

### Implementations

#### `PluginEmbedder`

Plugin-based embedder that delegates to the `adi.embed` plugin service.

```rust
impl PluginEmbedder {
    pub fn new(plugin_manager: Arc<PluginManagerV3>) -> Result<Self>;
    pub fn is_available(plugin_manager: &PluginManagerV3) -> bool;
}
```

**Example:**
```rust
// Check if embedder plugin is available
if PluginEmbedder::is_available(&plugin_manager) {
    let embedder = PluginEmbedder::new(plugin_manager)?;
    let embeddings = embedder.embed(&["sample text"])?;
}
```

#### `FastEmbedder` (fastembed feature)

Local ONNX-based embedder using the FastEmbed library.

```rust
#[cfg(feature = "fastembed")]
impl FastEmbedder {
    pub fn new() -> Result<Self>;
    pub fn with_config(config: &EmbeddingConfig) -> Result<Self>;
    pub fn from_user_config() -> Result<Self>;
}
```

**Example:**
```rust
#[cfg(feature = "fastembed")]
use lib_embed::FastEmbedder;

#[cfg(feature = "fastembed")]
{
    let embedder = FastEmbedder::new()?;
    let embeddings = embedder.embed(&["code snippet", "documentation"])?;
}
```

### Configuration

#### `EmbeddingConfig`

Configuration structure for embedding providers.

```rust
pub struct EmbeddingConfig {
    pub provider: String,           // Provider name (e.g., "fastembed")
    pub model: String,              // Model identifier
    pub dimensions: u32,            // Embedding dimensions
    pub batch_size: usize,          // Batch size for embedding
    pub api_key: Option<String>,    // Optional API key for remote providers
    pub api_base: Option<String>,   // Optional API base URL
}
```

**Methods:**
- **`load_user_config()`** - Loads config from user's ADI config directory
- **`load_from_file(path)`** - Loads config from a specific TOML file
- **`merge(other)`** - Merges two configs, preferring non-default values from `other`

**Example:**
```rust
use lib_embed::EmbeddingConfig;

// Load user configuration
let config = EmbeddingConfig::load_user_config()?;

// Create custom configuration
let custom_config = EmbeddingConfig {
    provider: "custom".to_string(),
    model: "custom-model".to_string(),
    dimensions: 1024,
    batch_size: 16,
    api_key: Some("your-api-key".to_string()),
    api_base: Some("https://api.example.com".to_string()),
};
```

### Error Types

#### `EmbedError`

Comprehensive error type for embedding operations.

```rust
pub enum EmbedError {
    Embedding(String),           // Embedding operation errors
    Config(String),              // Configuration errors
    Io(std::io::Error),          // File I/O errors
    TomlParse(toml::de::Error),  // TOML parsing errors
    TomlSerialize(toml::ser::Error), // TOML serialization errors
}
```

## Common Patterns

### 1. Plugin-Based Embeddings (Recommended)

```rust
use lib_embed::{Embedder, PluginEmbedder};
use lib_plugin_host::PluginManagerV3;
use std::sync::Arc;

fn create_plugin_embedder() -> lib_embed::Result<Box<dyn Embedder>> {
    let plugin_manager = Arc::new(PluginManagerV3::new());
    
    if PluginEmbedder::is_available(&plugin_manager) {
        let embedder = PluginEmbedder::new(plugin_manager)?;
        Ok(Box::new(embedder))
    } else {
        Err(lib_embed::EmbedError::Config(
            "No embedding plugin found. Run: adi plugin install adi.embed".to_string()
        ))
    }
}
```

### 2. Fallback Strategy

```rust
use lib_embed::{Embedder, PluginEmbedder, EmbeddingConfig};

fn create_embedder_with_fallback() -> lib_embed::Result<Box<dyn Embedder>> {
    let plugin_manager = Arc::new(PluginManagerV3::new());
    
    // Try plugin first
    if PluginEmbedder::is_available(&plugin_manager) {
        let embedder = PluginEmbedder::new(plugin_manager)?;
        return Ok(Box::new(embedder));
    }
    
    // Fallback to local fastembed if available
    #[cfg(feature = "fastembed")] 
    {
        use lib_embed::FastEmbedder;
        let embedder = FastEmbedder::from_user_config()?;
        return Ok(Box::new(embedder));
    }
    
    Err(lib_embed::EmbedError::Config(
        "No embedding backend available".to_string()
    ))
}
```

### 3. Batch Processing with Configuration

```rust
use lib_embed::{Embedder, EmbeddingConfig};

async fn process_documents(
    embedder: &dyn Embedder, 
    documents: &[String]
) -> lib_embed::Result<Vec<Vec<f32>>> {
    let config = EmbeddingConfig::load_user_config()?;
    let batch_size = config.batch_size;
    
    let mut all_embeddings = Vec::new();
    
    for chunk in documents.chunks(batch_size) {
        let text_refs: Vec<&str> = chunk.iter().map(|s| s.as_str()).collect();
        let embeddings = embedder.embed(&text_refs)?;
        all_embeddings.extend(embeddings);
    }
    
    Ok(all_embeddings)
}
```

## Error Handling

The library uses a comprehensive `Result<T>` type with detailed error information:

```rust
use lib_embed::{EmbedError, Result};

fn handle_embedding_errors(embedder: &dyn Embedder, text: &str) -> Result<Vec<f32>> {
    match embedder.embed(&[text]) {
        Ok(mut embeddings) => {
            embeddings.pop()
                .ok_or_else(|| EmbedError::Embedding("No embedding returned".to_string()))
        }
        Err(EmbedError::Embedding(msg)) => {
            eprintln!("Embedding failed: {}", msg);
            Err(EmbedError::Embedding(msg))
        }
        Err(EmbedError::Config(msg)) => {
            eprintln!("Configuration error: {}", msg);
            Err(EmbedError::Config(msg))
        }
        Err(EmbedError::Io(err)) => {
            eprintln!("I/O error: {}", err);
            Err(EmbedError::Io(err))
        }
        Err(other) => Err(other),
    }
}
```

## See Also

- **lib-plugin-host** - Plugin management system for ADI tools
- **lib-plugin-abi-v3** - Plugin ABI definitions for v3 architecture
- **FastEmbed** - ONNX-based embedding library (when using `fastembed` feature)
- **ADI Plugin Registry** - Install embedding plugins with `adi plugin install adi.embed`
