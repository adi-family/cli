# ADI Bulk Plugin Release Workflow
# Wraps scripts/release-plugins.sh for releasing multiple plugins

[workflow]
name = "release-plugins"
description = "Release all core plugins to the registry"

[[inputs]]
name = "version_bump"
type = "select"
prompt = "Version bump type"
options = [
    "same - Keep current version",
    "patch - Bug fixes (0.0.x)",
    "minor - New features (0.x.0)",
    "major - Breaking changes (x.0.0)"
]
default = "same - Keep current version"

[[inputs]]
name = "specific_plugin"
type = "select"
prompt = "Release specific plugin? (or all)"
# First option is "all", then dynamically discovered plugins from plugin.toml
options_cmd = """
echo 'all'
find crates -name 'plugin.toml' -type f 2>/dev/null | while read f; do
    grep -m1 '^id = ' "$f" 2>/dev/null | sed 's/id = "//;s/"//'
done | sort -u
"""
default = "all"

[[steps]]
name = "Release plugins"
run = """
# Prelude variables and functions are automatically available

BUMP="{{ version_bump | split(' ') | first }}"
PLUGIN="{{ specific_plugin }}"

info "Releasing plugins (bump: $BUMP, plugin: $PLUGIN)"

BUMP_FLAG=""
if [ "$BUMP" != "same" ]; then
    BUMP_FLAG="--bump $BUMP"
fi

if [ "$PLUGIN" = "all" ]; then
    "$WORKFLOWS_DIR/release-plugins.sh" $BUMP_FLAG
else
    "$WORKFLOWS_DIR/release-plugins.sh" --plugin "$PLUGIN" $BUMP_FLAG
fi
"""
