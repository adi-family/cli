# ADI Plugin Release Workflow
# Wraps scripts/release-plugin.sh functionality into an interactive workflow

[workflow]
name = "release-plugin"
description = "Build and publish a plugin to the registry"

[[inputs]]
name = "plugin"
type = "select"
prompt = "Select plugin to release"
# Dynamic options: discover plugins from crates/*/plugin directories
options_source = { type = "plugins" }
autocomplete = true

[[inputs]]
name = "version_bump"
type = "select"
prompt = "Version bump type"
options = [
    "same - Keep current version",
    "patch - Bug fixes (0.0.x)",
    "minor - New features (0.x.0)",
    "major - Breaking changes (x.0.0)"
]
default = "same - Keep current version"

[[inputs]]
name = "registry_target"
type = "select"
prompt = "Target registry"
options = [
    "production - adi-plugin-registry.the-ihor.com",
    "local - localhost:8019",
    "dry-run - Build only, no publish"
]
default = "production - adi-plugin-registry.the-ihor.com"

[[steps]]
name = "Release plugin"
run = """
# Prelude variables and functions are automatically available

PLUGIN="{{ plugin }}"
TARGET="{{ registry_target | split(' ') | first }}"
BUMP="{{ version_bump | split(' ') | first }}"

info "Releasing plugin: $PLUGIN to $TARGET (version bump: $BUMP)"

BUMP_FLAG=""
if [ "$BUMP" != "same" ]; then
    BUMP_FLAG="--bump $BUMP"
fi

case "$TARGET" in
    production)
        "$WORKFLOWS_DIR/release-plugin.sh" "$PLUGIN" $BUMP_FLAG
        ;;
    local)
        "$WORKFLOWS_DIR/release-plugin.sh" "$PLUGIN" --local $BUMP_FLAG
        ;;
    dry-run)
        "$WORKFLOWS_DIR/release-plugin.sh" "$PLUGIN" --no-push $BUMP_FLAG
        ;;
esac
"""
