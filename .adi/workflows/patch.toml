# ADI Patch Workflow
# Quick build + replace for CLI binary or plugin (local dev iteration)

[workflow]
name = "patch"
description = "Build and patch CLI binary or plugin locally (with macOS codesign)"

[[inputs]]
name = "target"
type = "select"
prompt = "What to patch?"
options = [
    "cli - Rebuild and replace adi binary (with codesign)",
    "plugin - Rebuild and reinstall a plugin locally"
]
default = "cli - Rebuild and replace adi binary (with codesign)"

[[inputs]]
name = "plugin"
type = "select"
prompt = "Select plugin to patch"
options_cmd = """
grep -rl 'package.metadata.plugin' crates/*/Cargo.toml crates/*/*/Cargo.toml crates/*/*/*/Cargo.toml 2>/dev/null | while read f; do
    sed -n 's/^id = "\(.*\)"/\1/p' "$f" | head -1
done | sort -u
"""
autocomplete = true
autocomplete_count = 10
condition = "{{ target | contains('plugin') }}"

[[steps]]
name = "Patch target"
run = """
TARGET="{{ target | split(' ') | first }}"
PLUGIN="{{ plugin }}"

case "$TARGET" in
    cli)
        "$WORKFLOWS_DIR/patch.sh" cli
        ;;
    plugin)
        "$WORKFLOWS_DIR/patch.sh" plugin "$PLUGIN"
        ;;
esac
"""
