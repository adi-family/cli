<!doctype html>
<html class="dark" lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kanban Execution Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="./src/index.css" />
    <script type="module" src="./src/components/app-header.ts"></script>
    <script type="module" src="./src/components/command-palette.ts"></script>
    <script type="module" src="./src/components/credentials-list.ts"></script>
    <script type="module" src="./src/components/credentials-form.ts"></script>
    <script type="module" src="./src/components/source-settings.ts"></script>
    <script type="module" src="./src/components/components-page.ts"></script>
    <script type="module" src="./src/setup-commands.ts"></script>
  </head>
  <body>
    <command-palette></command-palette>
    <app-header
      title="Kanban Execution"
      user-avatar="https://lh3.googleusercontent.com/aida-public/AB6AXuBS5VZ6TmX9fBtggBexSxdj8szNy3AaOVw3TyerXfIbg0XynEbNqO1XdUXTXpysdpUQtJxksKiEV2DvhVcIDVNJUOcgCSS0XVt8otOb6S93hiLi_z386lyvSpPkiR504aqLmxbTfkwpYPVDOkDjRcSHpUngrlNVhhC8utR3KoF85-nMxx2J0lu1bWIN0ClETt1W6FFzgY2pk--MIyMczsSqwoSLCiGLWiepNlZeKKM7HV-QoBAgEvo0pHhG2r2SNdw297h0FBQqahI"
    ></app-header>

    <!-- Main content area -->
    <main class="flex-1" style="overflow: auto; height: calc(100vh - 4rem);">
      <credentials-list id="credentials-view"></credentials-list>
      <credentials-form id="credentials-form"></credentials-form>
      <source-settings id="source-settings"></source-settings>
      <components-page id="components-view" style="display: none; height: 100%; overflow: auto;"></components-page>
    </main>

    <script type="module">
      import { router } from './src/services/router.ts';

      const header = document.querySelector('app-header');
      const credentialsList = document.getElementById('credentials-view');
      const credentialsForm = document.getElementById('credentials-form');
      const sourceSettings = document.getElementById('source-settings');
      const componentsView = document.getElementById('components-view');

      function updateView(route) {
        // Hide all views
        credentialsList.visible = false;
        sourceSettings.visible = false;
        componentsView.style.display = 'none';

        // Update header active state
        header.activeNav = route;

        // Show selected view
        switch (route) {
          case 'credentials':
            credentialsList.visible = true;
            break;
          case 'settings':
            sourceSettings.visible = true;
            break;
          case 'components':
            componentsView.style.display = 'block';
            break;
          case 'board':
          case 'list':
          case 'timeline':
          case 'insights':
            // TODO: Implement these views
            console.log(`View "${route}" not yet implemented`);
            break;
        }
      }

      // Handle nav clicks
      header.addEventListener('nav-change', (e) => {
        router.navigate(e.detail.navId);
      });

      // Subscribe to route changes
      router.subscribe(updateView);

      // Handle credentials events
      credentialsList.addEventListener('credential-add', () => {
        credentialsForm.credential = null;
        credentialsForm.open = true;
      });

      credentialsList.addEventListener('credential-edit', (e) => {
        credentialsForm.credential = e.detail.credential;
        credentialsForm.open = true;
      });

      credentialsForm.addEventListener('saved', () => {
        // Refresh credentials list after save
        import('./src/stores/credentials.ts').then(({ credentialsStore }) => {
          credentialsStore.refresh();
        });
      });

      // Handle settings close
      sourceSettings.addEventListener('close', () => {
        router.navigate('credentials');
      });

      // Handle Cmd+R / Ctrl+R to refresh content instead of page
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'r') {
          e.preventDefault();
          
          // Refresh content based on current route
          const route = router.route;
          switch (route) {
            case 'credentials':
              credentialsList.loadCredentials();
              break;
            // Add more routes as needed
          }
        }
      });

      // Initialize router
      router.init();
    </script>
  </body>
</html>
